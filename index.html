import smtplib
import os
import json
import time
import threading
from datetime import datetime, timedelta
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
import schedule
from flask import Flask, request, jsonify, render_template_string


class StoryAssessmentEmailSystem:
    def __init__(self):
        # Email configuration - UPDATE THESE WITH YOUR CREDENTIALS
        self.smtp_server = "smtp.gmail.com"
        self.smtp_port = 587
        self.sender_email = "your_email@gmail.com"  # Your email
        self.sender_password = "your_app_password"  # Your Gmail App Password
        self.admin_email = "sanphatsamura@gmail.com"

        # File to store email list
        self.email_list_file = "email_list.json"

        # Website URL
        self.website_url = "https://samurainoi.github.io/Personal-Narrative-Assessment-Tool-Application/"

        # Load existing email list
        self.load_email_list()

    def load_email_list(self):
        """Load email list from JSON"""
        try:
            with open(self.email_list_file, 'r') as f:
                self.email_list = json.load(f)
        except FileNotFoundError:
            self.email_list = []

    def save_email_list(self):
        """Save email list to JSON"""
        with open(self.email_list_file, 'w') as f:
            json.dump(self.email_list, f, indent=2)

    def add_email_to_list(self, email):
        """Add email entry with timestamp"""
        email_entry = {
            "email": email,
            "timestamp": datetime.now().isoformat(),
            "date": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        self.email_list.append(email_entry)
        self.save_email_list()

    def setup_chrome_driver(self):
        """Setup Chrome driver"""
        chrome_options = Options()
        chrome_options.add_argument("--headless=new")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--window-size=1920,1080")
        try:
            driver = webdriver.Chrome(options=chrome_options)
            return driver
        except Exception as e:
            print(f"Error setting up Chrome driver: {e}")
            return None

    def take_screenshot(self):
        """Take screenshot of website"""
        driver = self.setup_chrome_driver()
        if not driver:
            return None
        try:
            driver.get(self.website_url)
            time.sleep(5)
            total_height = driver.execute_script("return document.body.scrollHeight")
            driver.set_window_size(1920, total_height)
            screenshot_filename = f"story_assessment_{datetime.now().strftime('%Y%m%d_%H%M%S')}.png"
            driver.save_screenshot(screenshot_filename)
            return screenshot_filename
        except Exception as e:
            print(f"Error taking screenshot: {e}")
            return None
        finally:
            driver.quit()

    def send_screenshot_email(self, recipient_email):
        """Send screenshot to user"""
        try:
            screenshot_file = self.take_screenshot()
            if not screenshot_file:
                return False

            self.add_email_to_list(recipient_email)

            msg = MIMEMultipart()
            msg['From'] = self.sender_email
            msg['To'] = recipient_email
            msg['Subject'] = "Your Story Assessment Results"

            body = f"""
            Hello,

            Thank you for completing the Story Assessment.
            Please find your complete assessment screenshot attached.

            Website: {self.website_url}
            Completed on: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

            Regards,  
            Story Assessment Team
            """
            msg.attach(MIMEText(body, 'plain'))

            with open(screenshot_file, "rb") as attachment:
                part = MIMEBase('application', 'octet-stream')
                part.set_payload(attachment.read())
                encoders.encode_base64(part)
                part.add_header('Content-Disposition', f'attachment; filename={screenshot_file}')
                msg.attach(part)

            server = smtplib.SMTP(self.smtp_server, self.smtp_port)
            server.starttls()
            server.login(self.sender_email, self.sender_password)
            server.sendmail(self.sender_email, recipient_email, msg.as_string())
            server.quit()

            os.remove(screenshot_file)
            print(f"Sent Story Assessment screenshot to {recipient_email}")
            return True

        except Exception as e:
            print(f"Error sending email: {e}")
            return False

    def send_daily_report(self):
        """Send daily report to admin"""
        try:
            day_ago = datetime.now() - timedelta(days=1)
            recent_emails = [
                entry for entry in self.email_list
                if datetime.fromisoformat(entry['timestamp']) >= day_ago
            ]

            msg = MIMEMultipart()
            msg['From'] = self.sender_email
            msg['To'] = self.admin_email
            msg['Subject'] = f"Daily Story Assessment Report - {datetime.now().strftime('%Y-%m-%d')}"

            body = f"Daily Report\n\nNew emails: {len(recent_emails)}\nTotal: {len(self.email_list)}\n"
            for e in recent_emails:
                body += f"\n{e['email']} at {e['date']}"

            msg.attach(MIMEText(body, 'plain'))

            server = smtplib.SMTP(self.smtp_server, self.smtp_port)
            server.starttls()
            server.login(self.sender_email, self.sender_password)
            server.sendmail(self.sender_email, self.admin_email, msg.as_string())
            server.quit()

            print(f"Daily report sent to {self.admin_email}")
            return True
        except Exception as e:
            print(f"Error sending daily report: {e}")
            return False

    def schedule_daily_reports(self):
        """Run scheduler for reports at 8pm daily"""
        schedule.every().day.at("20:00").do(self.send_daily_report)

        def run_scheduler():
            while True:
                schedule.run_pending()
                time.sleep(60)

        thread = threading.Thread(target=run_scheduler, daemon=True)
        thread.start()
        print("Daily scheduler started")


# -----------------------------
# Flask Web App
# -----------------------------
app = Flask(__name__)
email_system = StoryAssessmentEmailSystem()

@app.route('/')
def index():
    return render_template_string("<h1>Story Assessment Tool</h1>")

@app.route('/submit-email', methods=['POST'])
def submit_email():
    data = request.json
    email = data.get("email")
    if email_system.send_screenshot_email(email):
        return jsonify({"status": "success"}), 200
    return jsonify({"status": "failure"}), 500


if __name__ == "__main__":
    email_system.schedule_daily_reports()
    app.run(host="0.0.0.0", port=5000)
