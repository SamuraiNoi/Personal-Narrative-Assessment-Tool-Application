import React, { useState, useEffect } from 'react';
import {
  Brain, TrendingUp, Target, Calendar, BarChart3, CheckCircle, AlertCircle,
  Info, Plus, ChevronRight, Award, Zap, Clock, Activity, Star, Lock, Unlock,
  TrendingDown, AlertTriangle, Settings, Download, Database, Shield, Eye,
  EyeOff, Moon, Sunrise, Coffee, Heart, Users, MapPin, Smartphone, Mail,
  MessageSquare, DollarSign, X, Check, ChevronDown, ChevronUp, HelpCircle
} from 'lucide-react';

// Define initial state function for clean reset/first load
const getInitialUserData = () => ({
  onboardingComplete: false,
  decisions: [],
  checkIns: [],
  joinedDate: new Date().toISOString(),

  // Enhanced data tracking (placeholders)
  sleepData: [{ date: new Date().toDateString(), duration: 420, quality: 3 }], // Mock sleep data for immediate warning visibility
  activityData: [],
  calendarData: [{ date: new Date().toDateString(), meetingCount: 2 }], // Mock calendar data
  communicationData: [],
  environmentData: [],
  substanceData: [],

  // Privacy & integration settings
  integrations: {
    sleep: { enabled: false, source: null, lastSync: null },
    calendar: { enabled: false, source: null, lastSync: null },
    activity: { enabled: false, source: null, lastSync: null },
    email: { enabled: false, source: null, lastSync: null },
    location: { enabled: false, lastSync: null },
    finance: { enabled: false, source: null, lastSync: null }
  },

  // Privacy preferences
  privacy: {
    dataStorageLocal: true,
    cloudSyncEnabled: false,
    analyticsEnabled: false,
    researchParticipation: false
  },

  // Skills system
  skills: {
    calibration: { xp: 0, level: 1 },
    evidenceGathering: { xp: 0, level: 1 },
    emotionalRegulation: { xp: 0, level: 1 },
    patternRecognition: { xp: 0, level: 1 },
    biasDetection: { xp: 0, level: 1 },
    riskAssessment: { xp: 0, level: 1 },
    contextAwareness: { xp: 0, level: 1 },
    domainExpertise: {
      career: { xp: 0, level: 1 },
      relationships: { xp: 0, level: 1 },
      health: { xp: 0, level: 1 },
      financial: { xp: 0, level: 1 }
    }
  },

  // User profile
  profile: {
    typicalSleepHours: 7,
    typicalWakeTime: '7:00',
    optimalDecisionHours: [],
    lifeRegime: 'single_career_focused'
  }
});

const Calibrate = () => {
  const [currentView, setCurrentView] = useState('welcome');
  const [userData, setUserData] = useState(getInitialUserData());

  // ==================== FIX 1: STATE PERSISTENCE (localStorage) ====================
  useEffect(() => {
    const savedData = localStorage.getItem('calibrateV5_userData');
    if (savedData) {
      const parsedData = JSON.parse(savedData);
      setUserData(parsedData);
      // Determine starting view
      if (parsedData.onboardingComplete) {
        setCurrentView('dashboard');
      }
    }
  }, []);

  useEffect(() => {
    // Save state on every change
    localStorage.setItem('calibrateV5_userData', JSON.stringify(userData));
  }, [userData]);
  // =================================================================================

  const daysSinceJoining = Math.floor(
    (new Date() - new Date(userData.joinedDate)) / (1000 * 60 * 60 * 24)
  );

  const unlocks = {
    basicStats: daysSinceJoining >= 7,
    patternDetection: userData.decisions.length >= 10,
    advancedCalibration: userData.decisions.filter(d => d.outcome !== null).length >= 20,
    integrations: daysSinceJoining >= 3,
    aiInsights: userData.decisions.filter(d => d.outcome !== null).length >= 15
  };

  // ==================== WELCOME SCREEN ====================
  const WelcomeScreen = () => {
    const [step, setStep] = useState(0);
    const [profile, setProfile] = useState({
      typicalSleepHours: 7,
      typicalWakeTime: '7:00',
      lifeRegime: 'single_career_focused'
    });

    const handleComplete = () => {
      setUserData({
        ...userData,
        onboardingComplete: true,
        profile: profile
      });
      setCurrentView('dashboard');
    };

    if (step === 0) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 text-white p-6 flex items-center justify-center">
          <div className="max-w-2xl">
            <div className="text-center mb-8">
              <Brain className="w-20 h-20 mx-auto mb-4 animate-pulse" />
              <h1 className="text-5xl font-bold mb-4">Calibrate</h1>
              <p className="text-2xl text-blue-100">Know When to Trust Your Gut</p>
            </div>

            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 mb-6">
              <h2 className="text-2xl font-bold mb-4">What is Calibrate?</h2>
              <p className="text-lg text-blue-50 mb-4">
                Most people are overconfident about some decisions and underconfident about others.
                Calibrate helps you discover your blind spots through decision tracking and outcome feedback.
              </p>

              <div className="space-y-4 my-6">
                <div className="flex items-start gap-3">
                  <CheckCircle className="w-6 h-6 text-green-300 flex-shrink-0 mt-1" />
                  <div>
                    <div className="font-semibold">Track Decision Quality</div>
                    <div className="text-sm text-blue-100">Log predictions with confidence levels, then track outcomes</div>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <CheckCircle className="w-6 h-6 text-green-300 flex-shrink-0 mt-1" />
                  <div>
                    <div className="font-semibold">Build Calibration</div>
                    <div className="text-sm text-blue-100">Learn if your "70% confident" predictions are actually 70% accurate</div>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <CheckCircle className="w-6 h-6 text-green-300 flex-shrink-0 mt-1" />
                  <div>
                    <div className="font-semibold">Discover Patterns</div>
                    <div className="text-sm text-blue-100">Find when you're overconfident (or underconfident) in specific contexts</div>
                  </div>
                </div>
              </div>

              <div className="bg-yellow-500/20 border border-yellow-400/50 rounded-lg p-4 mb-6">
                <div className="flex items-start gap-2">
                  <Info className="w-5 h-5 text-yellow-300 flex-shrink-0 mt-0.5" />
                  <div className="text-sm">
                    <strong>Based on Research:</strong> Tetlock's "Superforecasting" found that people who track predictions
                    improve accuracy by 50%+ through calibration feedback.
                  </div>
                </div>
              </div>
            </div>

            <button
              onClick={() => setStep(1)}
              className="w-full bg-white text-blue-700 py-4 rounded-xl font-bold text-lg hover:bg-blue-50 transition-colors"
            >
              Get Started
            </button>
            <p className="text-center text-sm text-blue-200 mt-4">
              Privacy-first • Data stays local • Takes 30 seconds/day
            </p>
          </div>
        </div>
      );
    }

    if (step === 1) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 text-white p-6 flex items-center justify-center">
          <div className="max-w-2xl w-full">
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8">
              <h2 className="text-2xl font-bold mb-6">Quick Profile Setup</h2>
              <p className="text-blue-100 mb-6">Help us personalize your experience (optional but recommended)</p>

              <div className="space-y-6">
                <div>
                  <label className="block font-medium mb-2">How many hours do you typically sleep?</label>
                  <input
                    type="number"
                    min="4"
                    max="12"
                    value={profile.typicalSleepHours}
                    onChange={(e) => setProfile({...profile, typicalSleepHours: parseInt(e.target.value)})}
                    className="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white text-lg"
                  />
                  <p className="text-sm text-blue-200 mt-1">We'll use this to detect when you're sleep-deprived</p>
                </div>

                <div>
                  <label className="block font-medium mb-2">What time do you typically wake up?</label>
                  <input
                    type="time"
                    value={profile.typicalWakeTime}
                    onChange={(e) => setProfile({...profile, typicalWakeTime: e.target.value})}
                    className="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white text-lg"
                  />
                  <p className="text-sm text-blue-200 mt-1">Helps identify your peak decision-making hours</p>
                </div>

                <div>
                  <label className="block font-medium mb-2">Current life context:</label>
                  <select
                    value={profile.lifeRegime}
                    onChange={(e) => setProfile({...profile, lifeRegime: e.target.value})}
                    className="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white text-lg"
                  >
                    <option value="single_career_focused">Single, Career-Focused</option>
                    <option value="partnered_dual_career">Partnered, Dual-Career</option>
                    <option value="parent_young_children">Parent, Young Children</option>
                    <option value="parent_teens">Parent, Teenagers</option>
                    <option value="caregiver">Caregiver</option>
                    <option value="student">Student</option>
                    <option value="career_transition">Career Transition</option>
                    <option value="health_recovery">Health Recovery</option>
                  </select>
                  <p className="text-sm text-blue-200 mt-1">Patterns vary by life stage—this helps us adapt</p>
                </div>
              </div>

              <div className="flex gap-4 mt-8">
                <button
                  onClick={() => setStep(0)}
                  className="flex-1 bg-white/20 text-white py-3 rounded-xl font-semibold hover:bg-white/30"
                >
                  Back
                </button>
                <button
                  onClick={handleComplete}
                  className="flex-1 bg-white text-blue-700 py-3 rounded-xl font-semibold hover:bg-blue-50"
                >
                  Complete Setup
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }
  };

  // ==================== ENHANCED LOG DECISION ====================
  const LogDecision = () => {
    const [newDecision, setNewDecision] = useState({
      title: '',
      context: '',
      prediction: 'positive',
      confidence: 50,
      evidence: '',
      domain: 'career',
      reversible: true,
      emotionalState: 'neutral',
      timeline: '3_months',
      peopleConsulted: 0,
      deliberationTime: 'less_than_hour',
      alternativesConsidered: 1
    });

    const [contextData, setContextData] = useState({
      recentSleep: null,
      currentMood: null,
      meetingsToday: 0,
      stressLevel: 'normal'
    });

    // Auto-populate context data
    useEffect(() => {
      // Get recent sleep data
      const lastSleep = userData.sleepData[userData.sleepData.length - 1];
      if (lastSleep) {
        const hoursSleep = lastSleep.duration / 60;
        setContextData(prev => ({
          ...prev,
          recentSleep: {
            hours: hoursSleep,
            quality: lastSleep.quality,
            belowBaseline: hoursSleep < userData.profile.typicalSleepHours
          }
        }));
      }

      // Get today's check-ins for mood
      const todayCheckIns = userData.checkIns.filter(c =>
        new Date(c.timestamp).toDateString() === new Date().toDateString()
      );
      if (todayCheckIns.length > 0) {
        const avgMood = todayCheckIns.reduce((sum, c) => sum + c.mood, 0) / todayCheckIns.length;
        setContextData(prev => ({...prev, currentMood: avgMood}));
      }

      // Calendar data for meeting count
      const todayCalendar = userData.calendarData.find(c =>
        new Date(c.date).toDateString() === new Date().toDateString()
      );
      if (todayCalendar) {
        setContextData(prev => ({...prev, meetingsToday: todayCalendar.meetingCount}));
      }
    }, [userData.sleepData, userData.checkIns, userData.calendarData, userData.profile.typicalSleepHours]);

    const handleSubmit = () => {
      if (!newDecision.title) return;

      const decision = {
        ...newDecision,
        id: Date.now(),
        date: new Date().toISOString(),
        outcome: null,
        outcomeDate: null,
        outcomeNotes: '',
        contextSnapshot: {
          ...contextData,
          timeOfDay: new Date().getHours(),
          dayOfWeek: new Date().getDay(),
          integrationStatus: {
            sleepTracked: contextData.recentSleep !== null,
            calendarSynced: contextData.meetingsToday > 0,
            moodTracked: contextData.currentMood !== null
          }
        }
      };

      // Award XP for logging decision
      const updatedSkills = {...userData.skills};

      // Evidence gathering XP
      if (newDecision.evidence.length > 20) {
        updatedSkills.evidenceGathering.xp += 30;
        updatedSkills.evidenceGathering.level = Math.floor(updatedSkills.evidenceGathering.xp / 150) + 1;
      }

      // Emotional regulation XP
      if (newDecision.emotionalState === 'calm') {
        updatedSkills.emotionalRegulation.xp += 40;
        updatedSkills.emotionalRegulation.level = Math.floor(updatedSkills.emotionalRegulation.xp / 180) + 1;
      }

      // Risk assessment XP
      updatedSkills.riskAssessment.xp += 35;
      updatedSkills.riskAssessment.level = Math.floor(updatedSkills.riskAssessment.xp / 160) + 1;

      // Context awareness XP (if integrations used)
      if (decision.contextSnapshot.integrationStatus.sleepTracked ||
          decision.contextSnapshot.integrationStatus.calendarSynced) {
        updatedSkills.contextAwareness.xp += 50;
        updatedSkills.contextAwareness.level = Math.floor(updatedSkills.contextAwareness.xp / 200) + 1;
      }

      // --- FIX 3: Domain Expertise XP ---
      const domain = newDecision.domain;
      if (updatedSkills.domainExpertise[domain]) {
          updatedSkills.domainExpertise[domain].xp += 50;
          updatedSkills.domainExpertise[domain].level =
              Math.floor(updatedSkills.domainExpertise[domain].xp / 200) + 1;
      }
      // ----------------------------------

      setUserData({
        ...userData,
        decisions: [...userData.decisions, decision],
        skills: updatedSkills
      });

      setCurrentView('dashboard');
    };

    // Context warnings
    const warnings = [];
    if (contextData.recentSleep?.belowBaseline) {
      warnings.push({
        type: 'warning',
        text: `You slept ${contextData.recentSleep.hours.toFixed(1)} hours (below your ${userData.profile.typicalSleepHours}h baseline). Decision quality may be impaired by ~20%.`
      });
    }
    if (contextData.meetingsToday >= 5) {
      warnings.push({
        type: 'warning',
        text: `You have ${contextData.meetingsToday} meetings today. Decision fatigue may reduce accuracy by ~15%.`
      });
    }
    if (contextData.currentMood && contextData.currentMood < 2.5) {
      warnings.push({
        type: 'warning',
        text: 'Your mood check-ins suggest low energy today. Consider deferring major decisions.'
      });
    }

    return (
      <div className="max-w-2xl mx-auto">
        <button
          onClick={() => setCurrentView('dashboard')}
          className="text-blue-600 hover:text-blue-800 mb-4 flex items-center gap-1"
        >
          ← Back to Dashboard
        </button>

        {warnings.length > 0 && (
          <div className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-6">
            <div className="flex items-start gap-3">
              <AlertTriangle className="w-6 h-6 text-yellow-600 flex-shrink-0 mt-1" />
              <div className="flex-1">
                <h3 className="font-bold text-yellow-900 mb-2">⚠️ Context Warnings</h3>
                {warnings.map((warning, i) => (
                  <p key={i} className="text-sm text-yellow-800 mb-1">{warning.text}</p>
                ))}
                <p className="text-sm text-yellow-700 mt-2 font-medium">
                  Consider: Is this decision time-sensitive, or can it wait until conditions improve?
                </p>
              </div>
            </div>
          </div>
        )}

        <div className="bg-white rounded-xl border-2 border-gray-200 p-8">
          <h2 className="text-3xl font-bold mb-2">Log a Decision</h2>
          <p className="text-gray-600 mb-6">
            Track a decision you're making today. We'll follow up based on your timeline to see how it turned out.
          </p>

          <div className="space-y-6">
            {/* Decision Title */}
            <div>
              <label className="block font-semibold text-gray-800 mb-2">
                What decision are you making? *
              </label>
              <input
                type="text"
                value={newDecision.title}
                onChange={(e) => setNewDecision({...newDecision, title: e.target.value})}
                placeholder="e.g., Accepting job offer at Company X"
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
              />
            </div>

            {/* Domain */}
            <div>
              <label className="block font-semibold text-gray-800 mb-2">Domain *</label>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                {['career', 'relationships', 'health', 'financial'].map(domain => (
                  <button
                    key={domain}
                    onClick={() => setNewDecision({...newDecision, domain})}
                    className={`py-2 px-4 rounded-lg font-medium capitalize transition-colors ${
                      newDecision.domain === domain
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    {domain}
                  </button>
                ))}
              </div>
            </div>

            {/* Prediction */}
            <div>
              <label className="block font-semibold text-gray-800 mb-2">
                What do you predict will happen? *
              </label>
              <div className="grid grid-cols-3 gap-3">
                <button
                  onClick={() => setNewDecision({...newDecision, prediction: 'positive'})}
                  className={`py-3 rounded-lg font-medium transition-colors ${
                    newDecision.prediction === 'positive'
                      ? 'bg-green-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  ✅ Positive
                </button>
                <button
                  onClick={() => setNewDecision({...newDecision, prediction: 'neutral'})}
                  className={`py-3 rounded-lg font-medium transition-colors ${
                    newDecision.prediction === 'neutral'
                      ? 'bg-yellow-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  😐 Neutral
                </button>
                <button
                  onClick={() => setNewDecision({...newDecision, prediction: 'negative'})}
                  className={`py-3 rounded-lg font-medium transition-colors ${
                    newDecision.prediction === 'negative'
                      ? 'bg-red-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  ❌ Negative
                </button>
              </div>
            </div>

            {/* Confidence */}
            <div>
              <label className="block font-semibold text-gray-800 mb-2">
                How confident are you? {newDecision.confidence}% *
              </label>
              <input
                type="range"
                min="10"
                max="90"
                step="5"
                value={newDecision.confidence}
                onChange={(e) => setNewDecision({...newDecision, confidence: parseInt(e.target.value)})}
                className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
              <div className="flex justify-between text-xs text-gray-500 mt-1">
                <span>10% (Guessing)</span>
                <span>50% (Coin flip)</span>
                <span>90% (Very sure)</span>
              </div>
            </div>

            {/* Timeline */}
            <div>
              <label className="block font-semibold text-gray-800 mb-2">
                When should we check the outcome? *
              </label>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                {[
                  { value: '1_week', label: '1 Week' },
                  { value: '1_month', label: '1 Month' },
                  { value: '3_months', label: '3 Months' },
                  { value: '6_months', label: '6 Months' },
                  { value: '1_year', label: '1 Year' },
                  { value: 'custom', label: 'Custom' }
                ].map(option => (
                  <button
                    key={option.value}
                    onClick={() => setNewDecision({...newDecision, timeline: option.value})}
                    className={`py-2 rounded-lg text-sm font-medium ${
                      newDecision.timeline === option.value
                        ? 'bg-purple-600 text-white'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    {option.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Evidence */}
            <div>
              <label className="block font-semibold text-gray-800 mb-2">
                What evidence supports your prediction?
                <span className="text-sm font-normal text-gray-600 ml-2">(+30 XP Evidence Gathering)</span>
              </label>
              <textarea
                value={newDecision.evidence}
                onChange={(e) => setNewDecision({...newDecision, evidence: e.target.value})}
                placeholder="List key facts, data points, or reasoning..."
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none h-24"
              />
              <div className="text-xs text-gray-500 mt-1">
                {newDecision.evidence.length} characters • Research shows decisions with documented evidence are 15% more accurate
              </div>
            </div>

            {/* Decision Process Context */}
            <div className="border-t pt-6">
              <h3 className="font-semibold text-gray-800 mb-4">Decision Process (helps detect patterns)</h3>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm text-gray-700 mb-2">Your emotional state right now:</label>
                  <div className="grid grid-cols-3 gap-2">
                    {['calm', 'neutral', 'stressed'].map(state => (
                      <button
                        key={state}
                        onClick={() => setNewDecision({...newDecision, emotionalState: state})}
                        className={`py-2 rounded-lg text-sm font-medium capitalize ${
                          newDecision.emotionalState === state
                            ? 'bg-blue-600 text-white'
                            : 'bg-gray-100 text-gray-700'
                        }`}
                      >
                        {state}
                      </button>
                    ))}
                  </div>
                </div>

                <div>
                  <label className="block text-sm text-gray-700 mb-2">Is this decision reversible?</label>
                  <div className="grid grid-cols-2 gap-2">
                    <button
                      onClick={() => setNewDecision({...newDecision, reversible: true})}
                      className={`py-2 rounded-lg text-sm font-medium ${
                        newDecision.reversible
                          ? 'bg-green-600 text-white'
                          : 'bg-gray-100 text-gray-700'
                      }`}
                    >
                      Yes (low stakes)
                    </button>
                    <button
                      onClick={() => setNewDecision({...newDecision, reversible: false})}
                      className={`py-2 rounded-lg text-sm font-medium ${
                        !newDecision.reversible
                          ? 'bg-red-600 text-white'
                          : 'bg-gray-100 text-gray-700'
                      }`}
                    >
                      No (high stakes)
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-sm text-gray-700 mb-2">How many people did you consult?</label>
                  <input
                    type="number"
                    min="0"
                    max="20"
                    value={newDecision.peopleConsulted}
                    onChange={(e) => setNewDecision({...newDecision, peopleConsulted: parseInt(e.target.value)})}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                  />
                  <div className="text-xs text-gray-500 mt-1">
                    Research shows consulting 2+ people improves accuracy by 22%
                  </div>
                </div>

                <div>
                  <label className="block text-sm text-gray-700 mb-2">How long have you been deliberating?</label>
                  <select
                    value={newDecision.deliberationTime}
                    onChange={(e) => setNewDecision({...newDecision, deliberationTime: e.target.value})}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                  >
                    <option value="less_than_hour">Less than 1 hour</option>
                    <option value="few_hours">Few hours</option>
                    <option value="one_day">About 1 day</option>
                    <option value="few_days">Few days</option>
                    <option value="week_plus">Week or more</option>
                  </select>
                </div>
              </div>
            </div>

            {/* Submit */}
            <button
              onClick={handleSubmit}
              disabled={!newDecision.title}
              className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Log Decision
            </button>
          </div>
        </div>

        <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div className="flex items-start gap-3">
            <Info className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
            <div className="text-sm text-blue-900">
              <strong>Why track process?</strong> Research shows decision quality depends on your process
              (evidence, consultation, emotional state) as much as the outcome. Tracking both helps you
              identify what improves your judgment.
            </div>
          </div>
        </div>
      </div>
    );
  };

  // ==================== INTEGRATIONS & PRIVACY VIEW ====================
  const IntegrationsView = () => {
    const [showPrivacySettings, setShowPrivacySettings] = useState(false);

    const integrationOptions = [
      {
        id: 'sleep',
        name: 'Sleep Tracking',
        icon: <Moon className="w-6 h-6" />,
        description: 'Track sleep duration and quality',
        sources: ['Oura Ring', 'Apple Watch', 'Whoop', 'Fitbit', 'Manual Entry'],
        value: 'High - Sleep predicts decision quality 24-48 hours later',
        dataCollected: 'Duration, quality score, bedtime/wake time',
        dataNotCollected: 'Heart rate details, movement data',
        impact: '30% variance in decision quality explained by sleep'
      },
      {
        id: 'calendar',
        name: 'Calendar Sync',
        icon: <Calendar className="w-6 h-6" />,
        description: 'Detect decision fatigue from meeting load',
        sources: ['Google Calendar', 'Outlook', 'Apple Calendar'],
        value: 'High - Meeting density predicts decision fatigue',
        dataCollected: 'Meeting count, duration, free time blocks',
        dataNotCollected: 'Meeting titles, attendees, content',
        impact: '25% variance in decision quality from meeting load'
      },
      {
        id: 'activity',
        name: 'Activity Tracking',
        icon: <Activity className="w-6 h-6" />,
        description: 'Exercise improves cognitive function',
        sources: ['Apple Health', 'Google Fit', 'Strava', 'Manual Entry'],
        value: 'Medium - Exercise boosts accuracy for 2-3 hours',
        dataCollected: 'Step count, exercise sessions, intensity',
        dataNotCollected: 'GPS routes, detailed workout data',
        impact: '15-20% accuracy boost on workout days'
      },
      {
        id: 'email',
        name: 'Communication Patterns',
        icon: <Mail className="w-6 h-6" />,
        description: 'Email volume as cognitive load indicator',
        sources: ['Gmail', 'Outlook'],
        value: 'Medium - High inbox correlates with overload',
        dataCollected: 'Message count, response time patterns',
        dataNotCollected: 'Message content, sender info, subject lines',
        impact: 'Stress proxy - accuracy drops when inbox >100'
      },
      {
        id: 'location',
        name: 'Location Context',
        icon: <MapPin className="w-6 h-6" />,
        description: 'Environmental impact on decisions',
        sources: ['Phone GPS (coarse location only)'],
        value: 'Low - Some users make different decisions while traveling',
        dataCollected: 'Location type (home/office/travel)',
        dataNotCollected: 'Exact addresses, movement patterns',
        impact: 'Varies by user - some travel poorly, others thrive'
      },
      {
        id: 'finance',
        name: 'Financial Stress Indicators',
        icon: <DollarSign className="w-6 h-6" />,
        description: 'Financial stress affects all decision types',
        sources: ['Plaid (bank integration)', 'Manual entry'],
        value: 'Medium - Financial strain impacts judgment',
        dataCollected: 'Balance trends (up/down/stable), large transactions',
        dataNotCollected: 'Actual amounts, account numbers, transaction details',
        impact: 'Financial stress → 15% worse in non-financial decisions'
      }
    ];

    const IntegrationCard = ({ integration }) => {
      const enabled = userData.integrations[integration.id]?.enabled;
      const [expanded, setExpanded] = useState(false);

      return (
        <div className={`bg-white rounded-xl border-2 ${enabled ? 'border-green-500' : 'border-gray-200'} p-6`}>
          <div className="flex items-start justify-between mb-4">
            <div className="flex items-start gap-4">
              <div className={`p-3 rounded-lg ${enabled ? 'bg-green-100' : 'bg-gray-100'}`}>
                {React.cloneElement(integration.icon, {
                  className: `w-6 h-6 ${enabled ? 'text-green-600' : 'text-gray-400'}`
                })}
              </div>
              <div>
                <h3 className="font-bold text-lg text-gray-800">{integration.name}</h3>
                <p className="text-sm text-gray-600">{integration.description}</p>
              </div>
            </div>
            <button
              onClick={() => {
                const newIntegrations = {...userData.integrations};
                newIntegrations[integration.id] = {
                  enabled: !enabled,
                  source: enabled ? null : integration.sources[0],
                  lastSync: enabled ? null : new Date().toISOString()
                };
                setUserData({...userData, integrations: newIntegrations});
              }}
              className={`px-4 py-2 rounded-lg font-medium ${
                enabled
                  ? 'bg-red-100 text-red-700 hover:bg-red-200'
                  : 'bg-blue-600 text-white hover:bg-blue-700'
              }`}
            >
              {enabled ? 'Disconnect' : 'Connect'}
            </button>
          </div>

          <div className="grid grid-cols-2 gap-4 mb-4 text-sm">
            <div>
              <div className="text-gray-600">Value</div>
              <div className="font-medium">{integration.value}</div>
            </div>
            <div>
              <div className="text-gray-600">Impact</div>
              <div className="font-medium">{integration.impact}</div>
            </div>
          </div>

          <button
            onClick={() => setExpanded(!expanded)}
            className="flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800"
          >
            {expanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            {expanded ? 'Hide' : 'Show'} Privacy Details
          </button>

          {expanded && (
            <div className="mt-4 p-4 bg-gray-50 rounded-lg space-y-3">
              <div>
                <div className="font-medium text-sm text-gray-700 mb-1">✅ We Collect:</div>
                <div className="text-sm text-gray-600">{integration.dataCollected}</div>
              </div>
              <div>
                <div className="font-medium text-sm text-gray-700 mb-1">❌ We Don't Collect:</div>
                <div className="text-sm text-gray-600">{integration.dataNotCollected}</div>
              </div>
              <div>
                <div className="font-medium text-sm text-gray-700 mb-1">Available Sources:</div>
                <div className="text-sm text-gray-600">{integration.sources.join(', ')}</div>
              </div>
            </div>
          )}
        </div>
      );
    };

    return (
      <div className="max-w-6xl mx-auto space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-3xl font-bold mb-2">Integrations & Privacy</h2>
            <p className="text-gray-600">Connect data sources to improve decision quality predictions</p>
          </div>
          <button
            onClick={() => setCurrentView('dashboard')}
            className="text-blue-600 hover:text-blue-800"
          >
            ← Dashboard
          </button>
        </div>

        {/* Privacy Overview */}
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border-2 border-blue-200 p-6">
          <div className="flex items-start gap-4">
            <Shield className="w-8 h-8 text-blue-600 flex-shrink-0" />
            <div className="flex-1">
              <h3 className="font-bold text-lg text-gray-800 mb-2">Privacy-First Design</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                  <div className="font-medium text-blue-900">🔒 Local Storage</div>
                  <div className="text-gray-700">All data stored on your device by default</div>
                </div>
                <div>
                  <div className="font-medium text-blue-900">🔐 You Control</div>
                  <div className="text-gray-700">Enable/disable each integration individually</div>
                </div>
                <div>
                  <div className="font-medium text-blue-900">📤 Full Export</div>
                  <div className="text-gray-700">Download or delete all data anytime</div>
                </div>
              </div>
              <button
                onClick={() => setShowPrivacySettings(!showPrivacySettings)}
                className="mt-4 text-sm text-blue-600 hover:text-blue-800 font-medium"
              >
                {showPrivacySettings ? 'Hide' : 'Show'} Privacy Settings
              </button>
            </div>
          </div>
        </div>

        {/* Privacy Settings Panel */}
        {showPrivacySettings && (
          <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
            <h3 className="font-bold text-lg mb-4">Privacy Preferences</h3>
            <div className="space-y-4">
              {[
                {
                  key: 'dataStorageLocal',
                  label: 'Store data locally on device',
                  description: 'Data never leaves your device unless you enable cloud sync'
                },
                {
                  key: 'cloudSyncEnabled',
                  label: 'Enable cloud sync (optional)',
                  description: 'Sync across devices using encrypted cloud storage'
                },
                {
                  key: 'analyticsEnabled',
                  label: 'Anonymous usage analytics',
                  description: 'Help us improve by sharing anonymized feature usage'
                },
                {
                  key: 'researchParticipation',
                  label: 'Participate in research',
                  description: 'Contribute anonymized data to behavioral science research'
                }
              ].map(setting => (
                <div key={setting.key} className="flex items-start justify-between p-4 bg-gray-50 rounded-lg">
                  <div className="flex-1">
                    <div className="font-medium text-gray-800">{setting.label}</div>
                    <div className="text-sm text-gray-600 mt-1">{setting.description}</div>
                  </div>
                  <button
                    onClick={() => {
                      const newPrivacy = {...userData.privacy};
                      newPrivacy[setting.key] = !newPrivacy[setting.key];
                      setUserData({...userData, privacy: newPrivacy});
                    }}
                    className={`ml-4 px-4 py-2 rounded-lg font-medium ${
                      userData.privacy[setting.key]
                        ? 'bg-green-600 text-white'
                        : 'bg-gray-300 text-gray-700'
                    }`}
                  >
                    {userData.privacy[setting.key] ? 'Enabled' : 'Disabled'}
                  </button>
                </div>
              ))}
            </div>

            <div className="mt-6 pt-6 border-t flex gap-4">
              <button className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2">
                <Download className="w-5 h-5" />
                Export All Data
              </button>
              <button className="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700">
                Delete All Data
              </button>
            </div>
          </div>
        )}

        {/* Integrations Grid */}
        <div className="space-y-4">
          <h3 className="text-xl font-bold">Available Integrations</h3>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            {integrationOptions.map(integration => (
              <IntegrationCard key={integration.id} integration={integration} />
            ))}
          </div>
        </div>

        {/* Value Explanation */}
        <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
          <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
            <HelpCircle className="w-6 h-6 text-blue-600" />
            Why Connect These?
          </h3>
          <div className="space-y-4 text-sm text-gray-700">
            <p>
              <strong>Research-backed context:</strong> Each integration provides data that's scientifically proven to affect
              decision quality. For example, sleep deprivation reduces prefrontal cortex function, impairing risk assessment.
            </p>
            <p>
              <strong>Personalized patterns:</strong> Generic advice says "get 8 hours sleep." Your data might show you're
              optimal at 7 hours, or that morning workouts boost your accuracy by 25%.
            </p>
            <p>
              <strong>Proactive warnings:</strong> Instead of discovering patterns after the fact, we can warn you in real-time:
              "You've had 3 poor sleep nights and 7 meetings today—consider deferring major decisions."
            </p>
            <p>
              <strong>Your choice:</strong> Every integration is optional. The core system works with just manual decision logging.
              Integrations enhance accuracy but aren't required.
            </p>
          </div>
        </div>
      </div>
    );
  };

  // ==================== DASHBOARD ====================
  const Dashboard = () => {
    const completedDecisions = userData.decisions.filter(d => d.outcome !== null);
    const accurateDecisions = completedDecisions.filter(d =>
      (d.prediction === 'positive' && d.outcome === 'positive') ||
      (d.prediction === 'negative' && d.outcome === 'negative')
    );
    const accuracy = completedDecisions.length > 0
      ? (accurateDecisions.length / completedDecisions.length) * 100
      : 0;

    const todayCheckIns = userData.checkIns.filter(c =>
      new Date(c.timestamp).toDateString() === new Date().toDateString()
    ).length;

    // Context alerts
    const contextAlerts = [];
    const lastSleep = userData.sleepData[userData.sleepData.length - 1];
    if (lastSleep && (lastSleep.duration / 60) < userData.profile.typicalSleepHours - 1) {
      contextAlerts.push({
        type: 'warning',
        text: `Sleep below baseline (${(lastSleep.duration / 60).toFixed(1)}h vs ${userData.profile.typicalSleepHours}h) - decision quality may be reduced`
      });
    }

    const todayCalendar = userData.calendarData.find(c =>
      new Date(c.date).toDateString() === new Date().toDateString()
    );
    if (todayCalendar && todayCalendar.meetingCount >= 5) {
      contextAlerts.push({
        type: 'warning',
        text: `High meeting load today (${todayCalendar.meetingCount} meetings) - watch for decision fatigue`
      });
    }

    const activeIntegrations = Object.values(userData.integrations).filter(i => i.enabled).length;

    return (
      <div className="space-y-6">
        {/* Status Banner */}
        <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h2 className="text-2xl font-bold">Your Calibration Journey</h2>
              <p className="text-blue-100">Day {daysSinceJoining} • {activeIntegrations} integrations active</p>
            </div>
            <Calendar className="w-12 h-12 opacity-50" />
          </div>

          <div className="grid grid-cols-3 gap-4">
            <div className="bg-white/20 rounded-lg p-3">
              <div className="text-sm text-blue-100">Decisions Logged</div>
              <div className="text-3xl font-bold">{userData.decisions.length}</div>
            </div>
            <div className="bg-white/20 rounded-lg p-3">
              <div className="text-sm text-blue-100">Outcomes Tracked</div>
              <div className="text-3xl font-bold">{completedDecisions.length}</div>
            </div>
            <div className="bg-white/20 rounded-lg p-3">
              <div className="text-sm text-blue-100">Today's Check-ins</div>
              <div className="text-3xl font-bold">{todayCheckIns}/3</div>
            </div>
          </div>
        </div>

        {/* Context Alerts */}
        {contextAlerts.length > 0 && (
          <div className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4">
            <div className="flex items-start gap-3">
              <AlertTriangle className="w-6 h-6 text-yellow-600 flex-shrink-0" />
              <div className="flex-1">
                <h3 className="font-bold text-yellow-900 mb-2">⚠️ Today's Context</h3>
                {contextAlerts.map((alert, i) => (
                  <p key={i} className="text-sm text-yellow-800 mb-1">{alert.text}</p>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Quick Actions */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <button
            onClick={() => setCurrentView('log-decision')}
            className="bg-white border-2 border-blue-200 rounded-xl p-6 hover:border-blue-400 hover:shadow-lg transition-all group"
          >
            <div className="flex items-center gap-4 mb-3">
              <div className="p-3 bg-blue-100 rounded-lg group-hover:bg-blue-200 transition-colors">
                <Plus className="w-6 h-6 text-blue-600" />
              </div>
              <h3 className="text-xl font-bold text-gray-800">Log Decision</h3>
            </div>
            <p className="text-gray-600 text-sm">Make a prediction about something important</p>
          </button>

          <button
            onClick={() => setCurrentView('check-in')}
            className="bg-white border-2 border-purple-200 rounded-xl p-6 hover:border-purple-400 hover:shadow-lg transition-all group"
          >
            <div className="flex items-center gap-4 mb-3">
              <div className="p-3 bg-purple-100 rounded-lg group-hover:bg-purple-200 transition-colors">
                <Zap className="w-6 h-6 text-purple-600" />
              </div>
              <h3 className="text-xl font-bold text-gray-800">Quick Check-in</h3>
            </div>
            <p className="text-gray-600 text-sm">How are you feeling right now? (5 sec)</p>
          </button>

          <button
            onClick={() => setCurrentView('integrations')}
            className="bg-white border-2 border-green-200 rounded-xl p-6 hover:border-green-400 hover:shadow-lg transition-all group"
          >
            <div className="flex items-center gap-4 mb-3">
              <div className="p-3 bg-green-100 rounded-lg group-hover:bg-green-200 transition-colors">
                <Database className="w-6 h-6 text-green-600" />
              </div>
              <h3 className="text-xl font-bold text-gray-800">Integrations</h3>
            </div>
            <p className="text-gray-600 text-sm">{activeIntegrations} connected • Improve predictions</p>
          </button>
        </div>

        {/* Current Stats */}
        {unlocks.basicStats ? (
          <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
            <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
              <Target className="w-6 h-6 text-blue-600" />
              Calibration Stats
            </h3>

            {completedDecisions.length >= 5 ? (
              <div className="space-y-4">
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-gray-600">Overall Accuracy</span>
                    <span className="text-2xl font-bold text-blue-600">{accuracy.toFixed(0)}%</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-3">
                    <div
                      className="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all"
                      style={{ width: `${accuracy}%` }}
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4 pt-4 border-t">
                  <div>
                    <div className="text-sm text-gray-600">Correct Predictions</div>
                    <div className="text-2xl font-bold text-green-600">{accurateDecisions.length}</div>
                  </div>
                  <div>
                    <div className="text-sm text-gray-600">Need Improvement</div>
                    <div className="text-2xl font-bold text-orange-600">
                      {completedDecisions.length - accurateDecisions.length}
                    </div>
                  </div>
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={() => setCurrentView('calibration')}
                    className="flex-1 bg-blue-50 text-blue-700 py-3 rounded-lg font-semibold hover:bg-blue-100 transition-colors"
                  >
                    View Calibration →
                  </button>
                  <button
                    onClick={() => setCurrentView('behavioral')}
                    className="flex-1 bg-purple-50 text-purple-700 py-3 rounded-lg font-semibold hover:bg-purple-100 transition-colors"
                  >
                    View Patterns →
                  </button>
                </div>
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <Target className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                <p>Track 5 outcomes to unlock calibration stats</p>
                <p className="text-sm mt-2">You're {5 - completedDecisions.length} away!</p>
              </div>
            )}
          </div>
        ) : (
          <div className="bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-8 text-center">
            <Clock className="w-12 h-12 mx-auto mb-3 text-gray-400" />
            <h3 className="font-bold text-gray-700 mb-2">Building Your Baseline</h3>
            <p className="text-gray-600 mb-4">
              Use Calibrate for 7 days to unlock calibration stats and pattern detection
            </p>
            <div className="w-full bg-gray-200 rounded-full h-3">
              <div
                className="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full"
                style={{ width: `${(daysSinceJoining / 7) * 100}%` }}
              />
            </div>
            <div className="text-sm text-gray-500 mt-2">
              {daysSinceJoining}/7 days complete
            </div>
          </div>
        )}

        {/* Pending Decisions */}
        {userData.decisions.filter(d => d.outcome === null).length > 0 && (
          <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
            <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
              <Clock className="w-6 h-6 text-orange-600" />
              Pending Outcomes ({userData.decisions.filter(d => d.outcome === null).length})
            </h3>
            <div className="space-y-3">
              {userData.decisions.filter(d => d.outcome === null).slice(-3).map(decision => (
                <div key={decision.id} className="flex items-start justify-between p-4 bg-gray-50 rounded-lg">
                  <div className="flex-1">
                    <div className="font-medium text-gray-800">{decision.title}</div>
                    <div className="text-sm text-gray-600 mt-1">
                      Predicted: {decision.prediction} • Confidence: {decision.confidence}%
                    </div>
                    <div className="text-xs text-gray-500 mt-1">
                      {new Date(decision.date).toLocaleDateString()} • Check back: {decision.timeline.replace('_', ' ')}
                    </div>
                  </div>
                  <button
                    className="ml-4 px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm font-medium hover:bg-blue-200"
                  >
                    Update
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Integration Prompts */}
        {activeIntegrations < 2 && unlocks.integrations && (
          <div className="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl border border-green-200 p-6">
            <div className="flex items-start gap-4">
              <Database className="w-8 h-8 text-green-600 flex-shrink-0" />
              <div className="flex-1">
                <h3 className="font-bold text-gray-800 mb-2">📈 Improve Your Predictions</h3>
                <p className="text-gray-700 text-sm mb-3">
                  Connect sleep tracking or calendar to get context-aware insights. Research shows this improves
                  prediction accuracy by 20-30%.
                </p>
                <button
                  onClick={() => setCurrentView('integrations')}
                  className="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700"
                >
                  View Integrations
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Simplified views to ensure the main component compiles
  const QuickCheckIn = () => {
    const [mood, setMood] = useState(null);
    const [compared, setCompared] = useState(null);

    const handleSubmit = () => {
      if (!mood) return;

      const checkIn = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        mood,
        comparedToYesterday: compared
      };

      // Award pattern recognition XP
      const updatedSkills = {...userData.skills};
      const checkInCount = userData.checkIns.length + 1;
      const consistentWeeks = Math.floor(checkInCount / 21);
      updatedSkills.patternRecognition.xp = consistentWeeks * 100;
      updatedSkills.patternRecognition.level = Math.floor(updatedSkills.patternRecognition.xp / 250) + 1;

      setUserData({
        ...userData,
        checkIns: [...userData.checkIns, checkIn],
        skills: updatedSkills
      });

      setCurrentView('dashboard');
    };

    return (
      <div className="max-w-2xl mx-auto">
        <button
          onClick={() => setCurrentView('dashboard')}
          className="text-blue-600 hover:text-blue-800 mb-4 flex items-center gap-1"
        >
          ← Back
        </button>

        <div className="bg-white rounded-xl border-2 border-gray-200 p-8">
          <h2 className="text-3xl font-bold mb-2">Quick Check-in</h2>
          <p className="text-gray-600 mb-8">Takes 5 seconds</p>

          <div className="space-y-8">
            <div>
              <label className="block font-semibold text-gray-800 mb-4 text-lg">
                Right now, how do you feel?
              </label>
              <div className="grid grid-cols-5 gap-3">
                {[
                  { emoji: '😢', label: 'Bad', value: 1 },
                  { emoji: '😕', label: 'Meh', value: 2 },
                  { emoji: '😐', label: 'Okay', value: 3 },
                  { emoji: '🙂', label: 'Good', value: 4 },
                  { emoji: '😊', label: 'Great', value: 5 }
                ].map(option => (
                  <button
                    key={option.value}
                    onClick={() => setMood(option.value)}
                    className={`py-6 rounded-xl transition-all ${
                      mood === option.value
                        ? 'bg-blue-600 text-white transform scale-105 shadow-lg'
                        : 'bg-gray-100 hover:bg-gray-200'
                    }`}
                  >
                    <div className="text-4xl mb-2">{option.emoji}</div>
                    <div className="text-sm font-medium">{option.label}</div>
                  </button>
                ))}
              </div>
            </div>

            <div>
              <label className="block font-semibold text-gray-800 mb-4 text-lg">
                Compared to yesterday:
              </label>
              <div className="grid grid-cols-5 gap-3">
                {[
                  { label: 'Much worse', value: -2 },
                  { label: 'Worse', value: -1 },
                  { label: 'Same', value: 0 },
                  { label: 'Better', value: 1 },
                  { label: 'Much better', value: 2 }
                ].map(option => (
                  <button
                    key={option.value}
                    onClick={() => setCompared(option.value)}
                    className={`py-4 rounded-xl text-sm font-medium transition-all ${
                      compared === option.value
                        ? 'bg-purple-600 text-white transform scale-105 shadow-lg'
                        : 'bg-gray-100 hover:bg-gray-200'
                    }`}
                  >
                    {option.label}
                  </button>
                ))}
              </div>
            </div>

            <button
              onClick={handleSubmit}
              disabled={!mood}
              className="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 transition-opacity disabled:opacity-50"
            >
              Save Check-in
            </button>
          </div>
        </div>
      </div>
    );
  };

  const CalibrationView = () => {
    return (
      <div className="max-w-4xl mx-auto">
        <button
          onClick={() => setCurrentView('dashboard')}
          className="text-blue-600 hover:text-blue-800 mb-4"
        >
          ← Back
        </button>
        <div className="bg-white rounded-xl border-2 border-gray-200 p-8">
          <h2 className="text-3xl font-bold mb-2">Calibration Curve</h2>
          <p className="text-gray-600 mb-6">
            Perfect calibration means your X% confident predictions are correct X% of the time
          </p>
          <div className="text-center py-12 text-gray-500">
            <Target className="w-16 h-16 mx-auto mb-4 text-gray-300" />
            <p>Track 5+ outcomes to see your calibration curve</p>
          </div>
        </div>
      </div>
    );
  };

  const BehavioralChartView = () => {
    return (
      <div className="max-w-6xl mx-auto">
        <button
          onClick={() => setCurrentView('dashboard')}
          className="text-blue-600 hover:text-blue-800 mb-4"
        >
          ← Back
        </button>
        <div className="bg-white rounded-xl border-2 border-gray-200 p-8">
          <h2 className="text-3xl font-bold mb-2">Behavioral Patterns</h2>
          <p className="text-gray-600 mb-6">Discover patterns in your decision-making</p>
          <div className="text-center py-12 text-gray-500">
            <Activity className="w-16 h-16 mx-auto mb-4 text-gray-300" />
            <p>Complete 10+ check-ins to unlock pattern detection</p>
          </div>
        </div>
      </div>
    );
  };

  const SkillsChartView = () => {
    // Helper function to calculate progress towards next level
    const calculateProgress = (xp, level) => {
        const baseXP = (level - 1) * 200; // Simplified scaling: 200 XP per level
        const requiredXP = 200 * level; // XP needed for the current level (e.g., L2 needs 400 total)
        const currentLevelXP = xp - baseXP;
        const nextLevelThreshold = 200; // XP needed *within* the current level

        if (level === 1) {
            return {
                current: xp,
                required: 150, // L1 threshold
                percent: Math.min(100, (xp / 150) * 100)
            }
        }

        return {
            current: currentLevelXP,
            required: nextLevelThreshold,
            percent: Math.min(100, (currentLevelXP / nextLevelThreshold) * 100)
        };
    };

    return (
      <div className="max-w-7xl mx-auto">
        <button
          onClick={() => setCurrentView('dashboard')}
          className="text-blue-600 hover:text-blue-800 mb-4"
        >
          ← Back
        </button>
        <div className="bg-white rounded-xl border-2 border-gray-200 p-8">
          <h2 className="text-3xl font-bold mb-2">Decision-Making Skills</h2>
          <p className="text-gray-600 mb-6">Track your growth across competencies</p>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {Object.entries(userData.skills)
                .filter(([key]) => key !== 'domainExpertise')
                .map(([key, skill]) => {
                const progress = calculateProgress(skill.xp, skill.level);
                return (
                    <div key={key} className="p-5 bg-gray-50 rounded-lg border border-gray-200">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="font-bold capitalize text-lg text-gray-800">{key.replace(/([A-Z])/g, ' $1').trim()}</h3>
                            <div className="flex items-center gap-1">
                                <Star className="w-5 h-5 text-yellow-500" />
                                <span className="text-2xl font-extrabold text-blue-600">{skill.level}</span>
                            </div>
                        </div>
                        <div className="text-sm text-gray-600 mb-2">
                            XP: {skill.xp} • Next Level: {progress.current}/{progress.required}
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2.5">
                            <div
                                className="bg-gradient-to-r from-blue-400 to-purple-500 h-2.5 rounded-full transition-all duration-500"
                                style={{ width: `${progress.percent}%` }}
                            ></div>
                        </div>
                    </div>
                );
            })}
          </div>

          <div className="mt-8 pt-6 border-t border-gray-200">
             <h3 className="text-2xl font-bold mb-4">Domain Expertise</h3>
             <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                {Object.entries(userData.skills.domainExpertise).map(([domain, skill]) => {
                    const progress = calculateProgress(skill.xp, skill.level);
                    return (
                        <div key={domain} className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div className="font-semibold capitalize text-blue-800">{domain}</div>
                            <div className="text-3xl font-bold text-blue-600 my-1">{skill.level}</div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div
                                    className="bg-blue-500 h-2 rounded-full"
                                    style={{ width: `${progress.percent}%` }}
                                ></div>
                            </div>
                            <div className="text-xs text-gray-600 mt-1">{progress.current}/{progress.required} XP</div>
                        </div>
                    );
                })}
             </div>
          </div>
        </div>
      </div>
    );
  };

  // ==================== MAIN LAYOUT ====================
  return (
    <div className="min-h-screen bg-gray-50">
      {currentView === 'welcome' && <WelcomeScreen />}

      {currentView !== 'welcome' && (
        <>
          {/* Header */}
          <div className="bg-white border-b shadow-sm">
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <Brain className="w-8 h-8 text-blue-600" />
                  <div>
                    <h1 className="text-2xl font-bold text-gray-800">Calibrate</h1>
                    <p className="text-sm text-gray-600">Decision Quality System</p>
                  </div>
                </div>

                {/* Navigation */}
                <div className="flex gap-2">
                  <button
                    onClick={() => setCurrentView('dashboard')}
                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                      currentView === 'dashboard'
                        ? 'bg-blue-600 text-white'
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    Dashboard
                  </button>
                  <button
                    onClick={() => setCurrentView('skills')}
                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                      currentView === 'skills'
                        ? 'bg-blue-600 text-white'
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    Skills
                  </button>
                  <button
                    onClick={() => setCurrentView('integrations')}
                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                      currentView === 'integrations'
                        ? 'bg-blue-600 text-white'
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    <Settings className="w-4 h-4 inline mr-1" />
                    Settings
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Content - FIX 2: Added missing view checks */}
          <div className="max-w-7xl mx-auto px-4 py-8">
            {currentView === 'dashboard' && <Dashboard />}
            {currentView === 'log-decision' && <LogDecision />}
            {currentView === 'check-in' && <QuickCheckIn />}
            {currentView === 'calibration' && <CalibrationView />}
            {currentView === 'behavioral' && <BehavioralChartView />}
            {currentView === 'skills' && <SkillsChartView />}
            {currentView === 'integrations' && <IntegrationsView />}
          </div>
        </>
      )}
    </div>
  );
};

export default Calibrate;
